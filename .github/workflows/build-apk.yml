name: Build Release APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout Repository
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: ğŸ” Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: ğŸ“ Grant Execute Permission for Gradlew
      run: chmod +x gradlew
    
    - name: ğŸ”§ Create google-services.json
      run: |
        echo "Creating google-services.json with embedded configuration..."
        cat > app/google-services.json << 'EOF'
        {
          "project_info": {
            "project_number": "354874868790",
            "project_id": "livetv-d9b81",
            "storage_bucket": "livetv-d9b81.firebasestorage.app"
          },
          "client": [
            {
              "client_info": {
                "mobilesdk_app_id": "1:354874868790:android:2c016cc71df885732f4497",
                "android_client_info": {
                  "package_name": "com.livetvpro"
                }
              },
              "oauth_client": [],
              "api_key": [
                {
                  "current_key": "AIzaSyBuaSp9csn6bo4d_617WE3pg3BVsUI9sH8"
                }
              ],
              "services": {
                "appinvite_service": {
                  "other_platform_oauth_client": []
                }
              }
            },
            {
              "client_info": {
                "mobilesdk_app_id": "1:354874868790:android:b0d1fed7cb74ac922f4497",
                "android_client_info": {
                  "package_name": "com.livetvpro.debug"
                }
              },
              "oauth_client": [],
              "api_key": [
                {
                  "current_key": "AIzaSyBuaSp9csn6bo4d_617WE3pg3BVsUI9sH8"
                }
              ],
              "services": {
                "appinvite_service": {
                  "other_platform_oauth_client": []
                }
              }
            }
          ],
          "configuration_version": "1"
        }
        EOF
        echo "âœ… Created google-services.json"
        cat app/google-services.json
    
    - name: ğŸ”‘ Generate Random Keystore
      run: |
        echo "ğŸ”‘ Generating random signing keystore..."
        
        # Generate random values
        RANDOM_PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
        RANDOM_ALIAS="release_key_$(date +%s)"
        RANDOM_DN="CN=ImShePro Plus, OU=Development, O=ImShePro, L=City, ST=State, C=US"
        
        echo "Generated credentials:"
        echo "  Alias: $RANDOM_ALIAS"
        echo "  Password: [HIDDEN]"
        
        # Generate keystore
        keytool -genkey -v \
          -keystore release-keystore.jks \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -alias "$RANDOM_ALIAS" \
          -storepass "$RANDOM_PASSWORD" \
          -keypass "$RANDOM_PASSWORD" \
          -dname "$RANDOM_DN" \
          2>&1 | grep -v "Warning"
        
        echo "âœ… Keystore generated: release-keystore.jks"
        ls -lh release-keystore.jks
        
        # Export variables for next steps
        echo "KEYSTORE_PASSWORD=$RANDOM_PASSWORD" >> $GITHUB_ENV
        echo "KEY_ALIAS=$RANDOM_ALIAS" >> $GITHUB_ENV
        echo "KEY_PASSWORD=$RANDOM_PASSWORD" >> $GITHUB_ENV
        
        # Display keystore info (without exposing passwords)
        echo ""
        echo "ğŸ“‹ Keystore Information:"
        keytool -list -v -keystore release-keystore.jks -storepass "$RANDOM_PASSWORD" 2>&1 | \
          grep -E "(Alias name|Creation date|Entry type|Owner|Issuer|Valid)" || true
    
    - name: ğŸ¨ Validate Launcher Icons
      run: |
        echo "ğŸ¨ Checking for launcher icons..."
        
        # Check if ic_launcher.xml exists
        if [ ! -f "app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml" ]; then
          echo "âš ï¸ Adaptive icons not found, will use existing PNG icons"
        else
          echo "âœ… Adaptive launcher icons found"
        fi
        
        # List all mipmap directories
        echo ""
        echo "ğŸ“ Mipmap directories:"
        ls -la app/src/main/res/ | grep mipmap || echo "No mipmap directories found"
        
        # Verify icons exist in at least one density
        if [ -f "app/src/main/res/mipmap-xxxhdpi/ic_launcher.png" ] || \
           [ -f "app/src/main/res/mipmap-xxxhdpi/ic_launcher.webp" ]; then
          echo "âœ… High-res launcher icon found"
        else
          echo "âš ï¸ Warning: High-res launcher icon missing"
          echo "   Build will continue with existing icons"
        fi
    
    - name: ğŸ“‹ Validate AndroidManifest.xml
      run: |
        echo "ğŸ“‹ Validating AndroidManifest.xml..."
        
        if [ -f "app/src/main/AndroidManifest.xml" ]; then
          echo "âœ… AndroidManifest.xml found"
          
          # Check for launcher icon reference
          if grep -q "android:icon=\"@mipmap/ic_launcher\"" app/src/main/AndroidManifest.xml; then
            echo "âœ… Launcher icon reference found"
          else
            echo "âš ï¸ Warning: No launcher icon reference in manifest"
          fi
          
          # Check for round icon
          if grep -q "android:roundIcon" app/src/main/AndroidManifest.xml; then
            echo "âœ… Round icon reference found (adaptive icons)"
          fi
          
          # Show application configuration
          echo ""
          echo "ğŸ“± Application Configuration:"
          grep -A5 "<application" app/src/main/AndroidManifest.xml | head -6
        else
          echo "âŒ AndroidManifest.xml not found!"
          exit 1
        fi
    
    - name: ğŸ§¹ Deep Clean Build Artifacts
      run: |
        echo "ğŸ§¹ Performing deep clean..."
        ./gradlew clean || true
        rm -rf .gradle
        rm -rf app/build
        rm -rf build
        rm -rf app/.cxx
        rm -rf ~/.gradle/caches/
        echo "âœ… Clean completed"
    
    - name: ğŸ” Pre-build Diagnostics
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“Š BUILD ENVIRONMENT INFORMATION"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        echo ""
        echo "â˜• Java Version:"
        java -version 2>&1 | head -3
        
        echo ""
        echo "ğŸ”§ Gradle Version:"
        ./gradlew --version | head -5
        
        echo ""
        echo "ğŸ“± Android SDK:"
        echo "  Location: $ANDROID_HOME"
        echo "  Build Tools: $(ls $ANDROID_HOME/build-tools 2>/dev/null | tail -1 || echo 'Not found')"
        
        echo ""
        echo "ğŸ’¾ Disk Space:"
        df -h / | tail -1 | awk '{print "  Available: " $4 " / " $2}'
        
        echo ""
        echo "ğŸ§  Memory:"
        free -h | grep "Mem:" | awk '{print "  Available: " $7 " / " $2}'
        
        echo ""
        echo "ğŸ”‘ Keystore Status:"
        echo "  File: release-keystore.jks"
        echo "  Size: $(ls -lh release-keystore.jks | awk '{print $5}')"
        echo "  Alias: $KEY_ALIAS"
        
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    - name: ğŸ“¦ Download Dependencies
      run: |
        echo "ğŸ“¦ Downloading and caching dependencies..."
        ./gradlew dependencies --no-daemon || true
        echo "âœ… Dependencies ready"
    
    - name: ğŸ”¨ Build Release APK
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ”¨ BUILDING RELEASE APK"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "Building all ABI variants..."
        echo "  - Universal"
        echo "  - ARM64 (arm64-v8a)"
        echo "  - ARMv7 (armeabi-v7a)"
        echo "  - x86_64"
        echo "  - x86"
        echo ""
        
        # Build with detailed output
        ./gradlew assembleRelease \
          --stacktrace \
          --no-daemon \
          --no-build-cache \
          --rerun-tasks \
          --warning-mode all \
          2>&1 | tee build.log
        
        BUILD_RESULT=${PIPESTATUS[0]}
        
        if [ $BUILD_RESULT -eq 0 ]; then
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… BUILD SUCCESSFUL!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        else
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ BUILD FAILED!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit $BUILD_RESULT
        fi
      env:
        KEYSTORE_FILE: ${{ github.workspace }}/release-keystore.jks
        KEYSTORE_PASSWORD: ${{ env.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ env.KEY_ALIAS }}
        KEY_PASSWORD: ${{ env.KEY_PASSWORD }}
    
    - name: ğŸ“Š Build Summary
      if: success()
      run: |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“Š BUILD SUMMARY"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        if [ -d "app/build/outputs/apk/release" ]; then
          echo ""
          echo "ğŸ“± Generated APK Files:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          
          APK_COUNT=0
          TOTAL_SIZE=0
          
          for apk in app/build/outputs/apk/release/*.apk; do
            if [ -f "$apk" ]; then
              FILENAME=$(basename "$apk")
              SIZE=$(stat -f%z "$apk" 2>/dev/null || stat -c%s "$apk")
              SIZE_MB=$(echo "scale=2; $SIZE/1048576" | bc)
              
              echo "  âœ… $FILENAME"
              echo "     Size: ${SIZE_MB} MB"
              echo ""
              
              APK_COUNT=$((APK_COUNT + 1))
              TOTAL_SIZE=$((TOTAL_SIZE + SIZE))
            fi
          done
          
          TOTAL_SIZE_MB=$(echo "scale=2; $TOTAL_SIZE/1048576" | bc)
          
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ“ˆ Statistics:"
          echo "  Total APKs: $APK_COUNT"
          echo "  Total Size: ${TOTAL_SIZE_MB} MB"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        else
          echo "âŒ APK output directory not found"
          exit 1
        fi
        
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    - name: ğŸ” Upload Build Log
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-failed
        path: build.log
        retention-days: 7
    
    - name: â¬†ï¸ Upload Universal APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: app-universal-release
        path: app/build/outputs/apk/release/app-universal-release.apk
        if-no-files-found: warn
    
    - name: â¬†ï¸ Upload ARM64 APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: app-arm64-v8a-release
        path: app/build/outputs/apk/release/app-arm64-v8a-release.apk
        if-no-files-found: warn
    
    - name: â¬†ï¸ Upload ARMv7 APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: app-armeabi-v7a-release
        path: app/build/outputs/apk/release/app-armeabi-v7a-release.apk
        if-no-files-found: warn
    
    - name: â¬†ï¸ Upload x86_64 APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: app-x86_64-release
        path: app/build/outputs/apk/release/app-x86_64-release.apk
        if-no-files-found: warn
    
    - name: â¬†ï¸ Upload x86 APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: app-x86-release
        path: app/build/outputs/apk/release/app-x86-release.apk
        if-no-files-found: warn
    
    - name: â¬†ï¸ Upload All APKs (Backup)
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: all-release-apks
        path: app/build/outputs/apk/release/*.apk
        if-no-files-found: error
        retention-days: 30
    
    - name: ğŸ“„ Generate Build Info
      if: success()
      run: |
        echo "# ğŸ‰ Build Successful!" > build-info.md
        echo "" >> build-info.md
        echo "## ğŸ“± Generated APK Files" >> build-info.md
        echo "" >> build-info.md
        
        for apk in app/build/outputs/apk/release/*.apk; do
          if [ -f "$apk" ]; then
            FILENAME=$(basename "$apk")
            SIZE=$(stat -f%z "$apk" 2>/dev/null || stat -c%s "$apk")
            SIZE_MB=$(echo "scale=2; $SIZE/1048576" | bc)
            
            echo "- **$FILENAME** - ${SIZE_MB} MB" >> build-info.md
          fi
        done
        
        echo "" >> build-info.md
        echo "## ğŸ”§ Build Configuration" >> build-info.md
        echo "" >> build-info.md
        echo "- **Build Type:** Release" >> build-info.md
        echo "- **Keystore:** Randomly generated (temporary)" >> build-info.md
        echo "- **Key Alias:** \`$KEY_ALIAS\`" >> build-info.md
        echo "- **Signed:** Yes âœ…" >> build-info.md
        echo "" >> build-info.md
        echo "## ğŸ“‹ Build Information" >> build-info.md
        echo "" >> build-info.md
        echo "- **Commit:** \`${{ github.sha }}\`" >> build-info.md
        echo "- **Branch:** \`${{ github.ref_name }}\`" >> build-info.md
        echo "- **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> build-info.md
        echo "- **Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> build-info.md
        echo "- **Triggered By:** ${{ github.actor }}" >> build-info.md
        echo "" >> build-info.md
        echo "## âš ï¸ Important Notes" >> build-info.md
        echo "" >> build-info.md
        echo "- This build uses a **randomly generated keystore** for demonstration purposes" >> build-info.md
        echo "- For production releases, use a **persistent keystore** stored in GitHub Secrets" >> build-info.md
        echo "- The keystore credentials are **not saved** and will be different each build" >> build-info.md
        echo "- If you need to update the app, you'll need to use the same keystore" >> build-info.md
        echo "" >> build-info.md
        echo "## ğŸ“¥ Download" >> build-info.md
        echo "" >> build-info.md
        echo "Download artifacts from the [Actions tab](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> build-info.md
        
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“„ Build Info Summary"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        cat build-info.md
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    - name: ğŸ“„ Upload Build Info
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: build-info
        path: build-info.md
        retention-days: 90
    
    - name: âœ… Final Status
      if: success()
      run: |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… BUILD COMPLETED SUCCESSFULLY!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ‰ All APK files have been generated and signed!"
        echo ""
        echo "ğŸ“¥ Download your APKs from:"
        echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "ğŸ”‘ Keystore Information (Temporary):"
        echo "   Alias: $KEY_ALIAS"
        echo "   Note: This keystore is randomly generated and not saved"
        echo ""
        echo "âš ï¸  For production use:"
        echo "   1. Generate a permanent keystore"
        echo "   2. Store it in GitHub Secrets (KEYSTORE_BASE64)"
        echo "   3. Update workflow to use the permanent keystore"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
