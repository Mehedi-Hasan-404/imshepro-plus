name: Build Release APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout Repository
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: ğŸ” Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: ğŸ“ Grant Execute Permission for Gradlew
      run: chmod +x gradlew
    
    - name: ğŸ”§ Create google-services.json from secrets
      run: |
        echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > app/google-services.json
        echo "âœ… Created google-services.json"
    
    - name: ğŸ”‘ Decode Keystore
      run: |
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > release-keystore.jks
        echo "âœ… Keystore decoded"
        ls -lh release-keystore.jks
    
    - name: ğŸ¨ Generate Launcher Icons (if needed)
      run: |
        echo "Checking for launcher icons..."
        
        # Check if ic_launcher.xml exists
        if [ ! -f "app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml" ]; then
          echo "âš ï¸ Adaptive icons not found, will use existing PNG icons"
        else
          echo "âœ… Launcher icons found"
        fi
        
        # List all mipmap directories
        echo "Current mipmap directories:"
        ls -la app/src/main/res/ | grep mipmap || echo "No mipmap directories found"
        
        # Verify icons exist in at least one density
        if [ -f "app/src/main/res/mipmap-xxxhdpi/ic_launcher.png" ] || \
           [ -f "app/src/main/res/mipmap-xxxhdpi/ic_launcher.webp" ]; then
          echo "âœ… High-res launcher icon found"
        else
          echo "âš ï¸ Warning: High-res launcher icon missing"
          echo "   Build will continue with existing icons"
        fi
    
    - name: ğŸ“‹ Validate AndroidManifest.xml
      run: |
        echo "Validating AndroidManifest.xml..."
        
        # Check if manifest exists
        if [ -f "app/src/main/AndroidManifest.xml" ]; then
          echo "âœ… AndroidManifest.xml found"
          
          # Check for launcher icon reference
          if grep -q "android:icon=\"@mipmap/ic_launcher\"" app/src/main/AndroidManifest.xml; then
            echo "âœ… Launcher icon reference found in manifest"
          else
            echo "âš ï¸ Warning: No launcher icon reference in manifest"
          fi
          
          # Check for round icon reference (adaptive icons)
          if grep -q "android:roundIcon" app/src/main/AndroidManifest.xml; then
            echo "âœ… Round icon reference found (adaptive icons)"
          fi
          
          # Show application tag
          echo "Application configuration:"
          grep -A5 "<application" app/src/main/AndroidManifest.xml | head -6
        else
          echo "âŒ AndroidManifest.xml not found!"
          exit 1
        fi
    
    - name: ğŸ§¹ Deep Clean Build Artifacts
      run: |
        echo "Performing deep clean to remove all cached files..."
        ./gradlew clean || true
        rm -rf .gradle
        rm -rf app/build
        rm -rf build
        rm -rf app/.cxx
        rm -rf ~/.gradle/caches/
        echo "âœ… Clean completed - all caches removed"
    
    - name: ğŸ” Pre-build Diagnostics
      run: |
        echo "=== Build Environment Info ==="
        echo "Java version:"
        java -version
        echo ""
        echo "Gradle version:"
        ./gradlew --version
        echo ""
        echo "Android SDK location:"
        echo $ANDROID_HOME
        echo ""
        echo "Available disk space:"
        df -h
        echo ""
        echo "Memory:"
        free -h
    
    - name: ğŸ“¦ Download Dependencies
      run: |
        echo "Downloading and caching dependencies..."
        ./gradlew dependencies --no-daemon || true
        echo "âœ… Dependencies downloaded"
    
    - name: ğŸ”¨ Build Release APK
      run: |
        echo "ğŸ”¨ Building all ABI variants..."
        ./gradlew assembleRelease \
          --stacktrace \
          --no-daemon \
          --no-build-cache \
          --rerun-tasks \
          --warning-mode all \
          2>&1 | tee build.log
        
        echo "âœ… Build completed!"
      env:
        KEYSTORE_FILE: ${{ github.workspace }}/release-keystore.jks
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
    
    - name: ğŸ“Š Build Summary
      if: always()
      run: |
        echo "=== BUILD SUMMARY ==="
        
        if [ -d "app/build/outputs/apk/release" ]; then
          echo "âœ… APK output directory exists"
          
          echo ""
          echo "=== Generated APKs ==="
          find app/build/outputs/apk/release -name "*.apk" -exec ls -lh {} \; | while read line; do
            echo "  ğŸ“± $line"
          done
          
          echo ""
          echo "=== APK Sizes ==="
          find app/build/outputs/apk/release -name "*.apk" -exec du -h {} \;
          
          echo ""
          echo "=== Total APKs Count ==="
          APK_COUNT=$(find app/build/outputs/apk/release -name "*.apk" | wc -l)
          echo "  ğŸ“Š Total: $APK_COUNT APK files"
        else
          echo "âŒ APK output directory not found"
          echo "Build may have failed. Check build.log"
        fi
    
    - name: ğŸ” Upload Build Log
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build.log
        retention-days: 7
    
    - name: â¬†ï¸ Upload Universal APK
      uses: actions/upload-artifact@v4
      with:
        name: app-universal-release
        path: app/build/outputs/apk/release/app-universal-release.apk
        if-no-files-found: warn
    
    - name: â¬†ï¸ Upload ARM64 APK
      uses: actions/upload-artifact@v4
      with:
        name: app-arm64-v8a-release
        path: app/build/outputs/apk/release/app-arm64-v8a-release.apk
        if-no-files-found: warn
    
    - name: â¬†ï¸ Upload ARMv7 APK
      uses: actions/upload-artifact@v4
      with:
        name: app-armeabi-v7a-release
        path: app/build/outputs/apk/release/app-armeabi-v7a-release.apk
        if-no-files-found: warn
    
    - name: â¬†ï¸ Upload x86_64 APK
      uses: actions/upload-artifact@v4
      with:
        name: app-x86_64-release
        path: app/build/outputs/apk/release/app-x86_64-release.apk
        if-no-files-found: warn
    
    - name: â¬†ï¸ Upload x86 APK
      uses: actions/upload-artifact@v4
      with:
        name: app-x86-release
        path: app/build/outputs/apk/release/app-x86-release.apk
        if-no-files-found: warn
    
    - name: â¬†ï¸ Upload All APKs (Backup)
      uses: actions/upload-artifact@v4
      with:
        name: all-release-apks
        path: app/build/outputs/apk/release/*.apk
        if-no-files-found: error
    
    - name: ğŸ“Š Generate APK Info
      if: success()
      run: |
        echo "# ğŸ‰ Build Successful!" > apk-info.md
        echo "" >> apk-info.md
        echo "## ğŸ“± Generated APKs" >> apk-info.md
        echo "" >> apk-info.md
        
        for apk in app/build/outputs/apk/release/*.apk; do
          if [ -f "$apk" ]; then
            filename=$(basename "$apk")
            size=$(du -h "$apk" | cut -f1)
            echo "- **$filename** - Size: $size" >> apk-info.md
          fi
        done
        
        echo "" >> apk-info.md
        echo "## ğŸ“‹ Build Info" >> apk-info.md
        echo "- Commit: \`${{ github.sha }}\`" >> apk-info.md
        echo "- Branch: \`${{ github.ref_name }}\`" >> apk-info.md
        echo "- Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> apk-info.md
        echo "- Workflow Run: #${{ github.run_number }}" >> apk-info.md
        
        cat apk-info.md
    
    - name: ğŸ“„ Upload Build Info
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: build-info
        path: apk-info.md
        retention-days: 30
    
    - name: âœ… Build Status
      if: success()
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… BUILD SUCCESSFUL!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ‰ All APKs have been built and uploaded successfully!"
        echo ""
        echo "ğŸ“¥ Download artifacts from the Actions tab:"
        echo "   https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
